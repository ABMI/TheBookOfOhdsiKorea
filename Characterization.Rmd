# 환자 특성 분석 Characterization {#Characterization}

*챕터 작성자 : Anthony Sena & Daniel Prieto-Alhambra*
*번역 : 박유진*

*Chapter leads: Anthony Sena & Daniel Prieto-Alhambra*

관찰형 보건의료 데이터베이스는 다양한 특성을 기반으로하는 인구의 변화를 이해하는데 유용한 자원을 제공합니다. 
Observational healthcare databases provide a valuable resource to understand variations in populations based on a host of characteristics.
기술 통계를 이용한 인구 특성 분석은 건강과 질병에 영향을 주는 결정 요인(determinants)에 대한 가설 설정을 위한 첫 번째 중요한 과정입니다.
Characterizing populations through the use of descriptive statistics is an important first step in generating hypotheses about the determinants of health and disease. 
이 챕터에서는 특성 분석을 위한 방법들을 소개할 것입니다:
In this chapter we cover methods for characterization:

* **데이터베이스 수준의 특성 분석 (Database-level characterization)**: 
데이터베이스의 데이터 프로파일을 전체적으로 이해하기 위한 상위 수준(top-level)의 기술 통계 세트를 제공합니다
provides a top-level set of summary statistics to understand the data profile of a database in its totality.
* **코호트의 특성 분석 (Cohort characterization)**: 
집계된 과거력으로 인구(population)를 설명합니다.
describes a population in terms of its aggregate medical history.
* **치료 경로 (Treatment pathways)**:
한 개인이 일정 기간 동안 받은 치료의 순서를 설명합니다.
describes the sequence of interventions a person received for a duration of time.
* **발생 (Incidence)**: 
인구집단에서 위험에 노출된 기간(time at risk, TAR)동안의 outcome의 발생률을 계산합니다.
measures the occurrence rate of an outcome in a population for a time at risk.

데이터베이스 수준의 특성 분석을 제외하고 위의 특성 분석 방법들은 index date라고 하는 시점과 관련된 인구 집단에 대해 설명하는 것을 목표로 합니다.
With the exception of database-level characterization, these methods aim to describe a population relative to an event referred to as the index date.
이처럼 관심이 있는 (분석하고자 하는) 인구집단을 본 챕터에서는 코호트라고 정의하겠습니다.
This population of interest is defined as a cohort as described in chapter \@ref(Cohorts). 
코호트는 관심 있는 인구집단의 개인 한명 한명에 대한 index date를 정의합니다.
The cohort defines the index date for each person in the population of interest. 
index date를 기준으로 하여 index date이전의 시간을 **기본(baseline)** 시간(time)이라 정의합니다. 
Using the index date as an anchor, we define the time preceding the index date as **baseline** time. 
index date를 포함한 그 이후의 시간들은 **index 후(post-index)** 시간(time)이라 합니다.
The index date and all time after is called the **post-index** time. 

특성 분석을 통해 다음과 같은 곳에서 활용할 수 있습니다: 질병의 자연사 (disease natural history), 치료의 이용(utilization)과 품질 개선.  
Use-cases for characterization include disease natural history, treatment utilization and quality improvement. 
이번 챕터에서는 특성 분석 방법에 대해 설명할 것입니다.
In this chapter will describe the methods for characterization. 
ATLAS와 R을 이용해 고혈압 집단에 대한 특성 분석 과정을 보여줄 것입니다.
We will use a population of hypertensive persons to demonstrate how to use ATLAS and R to perform these characterization tasks.\index{characterization} \index{cohort characterization|see {characterization!cohort}} \index{baseline time} \index{post-index time} \index{index date} \index{disease natural history|see {characterization}} \index{treatment utilization|see {characterization}} \index{quality improvement|see {characterization}}

## 데이터베이스 수준의 특성 분석 (Database Level Characterization)

우리가 관심있는 인구 집단에 대한 특성 분석을 시행하기 전에 우리가 사용하고자 하는 데이터베이스의 특성을 이해하는 것이 선행되어야 합니다.
Before we can answer any characterization question about a population of interest, we must first understand the characteristics of the database we intend to utilize. 
데이터베이스 수준의 특성 분석은 일시적인 트렌드와 분포의 관점에서 데이터베이스를 전체적으로 설명하는데 사용됩니다.
Database level characterization seeks to describe the totality of a database in terms of the temporal trends and distributions. 
이러한 데이터베이스의 정량적인 평가는 다음과 같은 물음을 전형적으로 포함합니다:
This quantitative assessment of a database will typically include questions such as: 

* 이 데이터베이스의 총 사람 수는 몇인가? 
What is the total count of persons in this database?
* 사람들의 연령 분포는 어떠한가?
What is the distribution of age for persons?
* 이 데이터베이스에 있는 사람들은 얼마나 오래 관찰되었는가?
How long are persons in this database observed for?
* 시간이 지남에 따라 기록/처방된 {치료, 질병, 처치 등}을 받은 사람의 분포는 어떠한가? 
What is the proportion of persons having a {treatment, condition, procedure, etc} recorded/prescribed over time?

이러한 데이터베이스 수준의 기술 통계는 연구자가 데이터베이스에 어떠한 데이터에서 손실이 있을 수 있는지를 이해할 수 있도록 합니다.
These database-level descriptive statistics also help a researcher to understand what data may be missing in a database. Chapter \@ref(DataQuality) goes into further detail on data quality. \index{characterization!database level}

## 코호트 특성 분석 (Cohort Characterization)

코호트 특성 분석은 코호트에 포함된 사람들의 기본(baseline)과 index 후(post-index) 특성에 대해 설명합니다.
Cohort characterization describes the baseline and post-index characteristics of people in a cohort. 
OHDSI에서는 개인의 과거에 존재한 모든 질병, 약물 및 치료재료에의 노출, 시술, 그리고 다른 임상적인 관찰에 대한 서술 통계를 통해 특성 분석을 시행하도록 합니다.
OHDSI approaches characterization through descriptive statistics of all conditions, drug and device exposures, procedures and other clinical observations that are present in the person’s history. 
또한 index date에서 코호트에 포함된 사람들의 사회인구통계에 대해 간략히 보여줍니다.
We also summarize the socio-demographics of members of the cohort at the index date. This approach provides a complete summary of the cohort of interest. 
무엇보다도 이와 같은 분석은 데이터의 변화에 주목하여 잠재적인 결측값에 대한 식별을 가능하게 하면서 코호트에 대한 전체적인 탐색을 가능하게 합니다. 
Importantly, this enables a full exploration of the cohort with an eye towards variation in the data while also allowing for identification of potentially missing values. 

코호트 특성 분석 방법은 주어진 치료를 받은 사람들 사이에 적응증(indications) 및 금기(contraindications)에 대한 유병률(prevalence)을 추정하기 위한 사람 수준 (person-level)의 약물 사용 연구 (drug utilization studies, DUS)에 사용될 수 있습니다.
Cohort characterization methods can be used for person-level drug utilization studies (DUS) to estimate the prevalence of indications and contraindications amongst users of a given treatment. 
이 코호특 특성 분석은 Strengthening the Reporting of Observational Studies in Epidemiology (STROBE) 가이드라인에 자세히 설명 된 관찰 연구에 권장되는 모범 사례입니다.   
The dissemination of this cohort characterization is a recommended best practice for observational studies as detailed in the Strengthening the Reporting of Observation Studies in Epidemiology (STROBE) guidelines. [@VONELM2008344] \index{characterization!cohort} \index{descriptive statistics|see {characterization}} \index{drug utilization}

## 치료 경로 (Treatment Pathways)

인구의 특성을 분석하는 또 하나의 방법은 index 후 (post-index) 시기 동안의 치료 순서에 대한 것입니다. 
Another method to characterize a population is to describe the treatment sequence during the post-index time window. 
예를 들어 @Hripcsak7329 은 OHDSI의 공통 데이터 표준을 활용해 제 2형 당뇨, 고혈압, 우울증에 대한 치료 경로 기술 통계를 만들었습니다.
For example, @Hripcsak7329 utilized the OHDSI common data standards to create descriptive statistics to characterize treatment pathways for type 2 diabetes, hypertension and depression. 
이런 분석 방법을 표준화 함으로써, Hripcsak과 그 연구팀은 관심있는 인구 집단의 특성 분석을 OHDSI 네트워크 상에서 동일한 통계방법으로 실행할 수 있었습니다.
By standardizing this analytic approach, Hripcsak and colleagues were able to run the same analysis across the OHDSI network to describe the characteristics of these populations of interest. \index{characterization!treatment pathways} \index{treatment pathways|see {characterization!treatment pathways}} \index{cohort pathways|see {characterization!treatment pathways}}

경로 분석은 특정 질환으로 진단된 환자가 받은 치료를 가장 처음 처방/조제된 약물부터 요약하기 위해 시행합니다.  
The pathway analysis aims to summarize the treatments (events) received by persons diagnosed with a specific condition from the first drug prescription/dispensation. 
이 연구에서는 제 2형 당뇨, 고혈압, 우울증의 진단 이후의 치료들을 분석했습니다. 
In this study, treatments were described after the diagnosis of type 2 diabetes, hypertension and depression respectively. 
개개인이 받은 치료(event)들은 이후 요약 통계 세트로 집계되고 각각의 질병과 각각의 데이터베이스에서 시각화됩니다. 
The events for each person were then aggregated to a set of summary statistics and visualized for each condition and for each database.

```{r treatmentPathwaysSunburstDataViz, fig.cap='OHDSI Treatment Pathways "sunburst" visualization for hypertension', echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/pnasTreatmentPathwaysSunburst.png")
```

예를 들어, figure \@ref(fig:treatmentPathwaysSunburstDataViz) 는 고혈압 치료를 시작한 사람들의 인구집단을 보여줍니다.
As an example, figure \@ref(fig:treatmentPathwaysSunburstDataViz) represents a population of persons initiating treatment for hypertension. 
중간으로부터 첫 번째 원은 그들이 가장 처음 받은 치료(first-line therapy)를 기준으로 한 사람들의 비율을 보여줍니다. 
The first ring in the center shows the proportion of persons based on their first-line therapy. 
예를 들어, Hydrochlorothiazide는 이 인구집단에서는 가장 흔하게 사용되는 첫 번째 치료 약물(first-line therapy)이라 할 수 있습니다. 
In this example, Hydrochlorothiazide is the most common first-line therapy for this population. 
Hydrochlorothiazide 부분에서 확장된 상자들은 해당 코호트에 속한 사람들에게서 기록된 두 번째, 세 번째 치료법을 나타냅니다.  
The boxes that extend from the Hydrochlorothiazide section represent the 2nd and 3rd line therapies recorded for persons in the cohort. 

경로 분석은 인구집단 내의 치료 활용에 대한 중요한 근거를 제공합니다. 
A pathways analysis provides important evidence about treatment utilization amongst a population. 
이 분석으로부터 우리는 가장 빈번히 사용되는 첫 번째 치료(first-line therapies)를 표현할 수 있고, 치료가 중단, 변경, 혹은 강화된 사람들의 비율을 알 수 있습니다. 
From this analysis we can describe the most prevalent first-line therapies utilized, the proportion of persons that discontinue treatment, switch treatments or augment their therapy. 
경로 분석을 통해 @Hripcsak7329 은 metformin이 당뇨에서 가장 일반적으로 처방된 임을 밝혔고, 미국 내분비학회의 당뇨 치료 알고리즘의 일차 추천 약제가 일반적으로 적용이 되고 있음을 확인했습니다. 
Using the pathway analysis, @Hripcsak7329 found that metformin is the most commonly prescribed medication for diabetes thus confirming general adoption of the first-line recommendation of the American Association of Clinical Endocrinologists diabetes treatment algorithm. 
더불어 당뇨 환자의 10%, 고혈압 환자의 24%, 그리고 우울증 환자의 11%는 다른 데이터베이스의 사람들과 공유되지 않는 치료 경로를 따르고 있다고 말했습니다. 
Additionally, they noted that 10% of diabetes patients, 24% of hypertension patients, and 11% of depression patients followed a treatment pathway that was shared with no one else in any of the data sources. 

전형적인 약물 사용 연구 (DUS) 용어로써 치료 경로 분석은 서로 다른 치료 간 지속과 변경을 측정하는 것을 포함하는 몇몇 사람 수준 (person-level)의 약물 사용 (DUS) 뿐 아니라 특정 인구집단에서 하나 이상의 약물 치료의 보급률과 같은 인구 수준 (population-level)의 약물 사용 (DUS)을 측정하는 연구를 모두 포함합니다. 
In classic DUS terminology, treatment pathway analyses include some population-level DUS estimates such as prevalence of use of one or more medications in a specified population, as well as some person-level DUS including measures of persistence and switching between different therapies.

## 발생 (Incidence)

발생률과 발생비는 공중 보건에서 위험에 노출된 기간 (time-at-risk, TAR)동안 인구집단 내 새로운 outcome의 발생의 평가에 사용되는 통계값입니다.
Incidence rates and proportions are statistics that are used in public health to assess the occurrence of a new outcome in a population during a time-at-risk (TAR).

Figure \@ref(fig:incidenceTimeline) 는 한 사람에게서 발생률 계산의 구성을 보여주고 있습니다: \index{incidence}
Figure \@ref(fig:incidenceTimeline) aims to show the components of an incidence calculation for a single person: \index{incidence}

```{r incidenceTimeline, fig.cap='Person-level view of incidence calculation components. In this example, time-at-risk is defined to start one day after cohort start, and end at cohort end.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/incidenceTimeline.png")
```

figure \@ref(fig:incidenceTimeline)에서 각각의 사람은 관찰 시작과 관찰 종료 시간으로 표시된 데이터에서 관찰된 기간을 갖습니다. 
In figure \@ref(fig:incidenceTimeline), a person has a period of time where they are observed in the data denoted by their observation start and end time. 
그 다음, 각각의 사람은 몇몇 조건 (eligibility criteria)에 의해 코호트에 들어가는 (enter) 시점과 나가는 (exit) 시점을 갖습니다. 
Next, the person has a point in time where they enter and exit a cohort by meeting some eligibility criteria. 
위험에 노출되는 (time at risk, TAR) 기간은 우리가 outcome의 발생을 보고자 하는 구간으로 표시합니다.
The time at risk window then denotes when we seek to understand the occurrence of an outcome. 
만일 outcome이 위험에 노출되는 구간 (time at risk, TAR)에서 발생한다면, outcome이 발생된 것으로 인정합니다. 
If the outcome falls into the TAR, we count that as an incidence of the outcome. 

발생을 계산하는 두 가지 식이 있습니다:  
There are two metrics for calculating incidence:


$$ 
발생\;분율 = \frac{\#\;코호트에\;포함된\;사람\;중\;TAR\;동안\;새로운\;outcome이\;있는\;경우}{\#\;TAR을\;가지면서\;코호트에\;포함된\;사람}
$$

$$ 
Incidence\;Proportion = \frac{\#\;persons\;in\;cohort\;with\;new\;outcome\;during\;TAR}{\#\;persons\;in\;cohort\;with\;TAR}
$$

발생 분율은 위험 노출 기간 (time-at-risk, TAR)동안 인구 집단 중 새로운 outcome의 발생을 측정을 나타냅니다.
An incidence proportion provides a measure of the new outcomes per person in the population during the time-at-risk. 
다른 방식으로 말하자면, 관심 있는 인구 집단에서 정해진 시간의 틀 안에서 발생한 outcome의 비율입니다.\index{incidence!proportion}
Stated another way, this is the proportion of the population of interest that developed the outcome in a defined timeframe.\index{incidence!proportion}

$$
발생률 = \frac{\#\;코호트에\;포함된\;사람\;중\;TAR\;동안\;새로운\;outcome이\;있는\;경우}{코호트에\;포함된\;사람들의\;위험\;노출\;기간\;(TAR)로\;구한\;인-시\;(person\;time\;at\;risk)}
$$

$$
Incidence\;Rate = \frac{\#\;persons\;in\;cohort\;with\;new\;outcome\;during\;TAR}{person\;time\;at\;risk\;contributed\;by\;persons\;in\;cohort}
$$

발생률은 인구집단에서 축적된 위험 노출 기간 (TAR)동안 새로 발생된 outcome의 횟수를 측정한 것을 말합니다. 
An incidence rate is a measure of the number of new outcomes during the cumulative TAR for the population. 
위험 노출 기간 (TAR)에서 outcome을 경험했을 때, 발생한 사람은 전체 인-시 (person-time)에 기여하는 개인의 인-시 (person-time)는 outcome이 발생한 시점에서 멈춥니다.
When a person experiences the outcome in the TAR, their contribution to the total person-time stops at the occurrence of the outcome event. 
축적된 위험 노출 기간 (TAR)은 **인-시(person-time)**라고 하고, 단위는 일, 개월, 혹은 년으로 표현합니다.\index{incidence!rate} \index{person-time}
The cumulative TAR is referred to as **person-time** and is expressed in days, months or years.\index{incidence!rate} \index{person-time}

치료 요법에 대하여 계산할 때, 주어진 치료 요법에 대한 발생 분율 혹은 발생률 계산은 전형적인 인구 집단 수준의 약물 사용 연구 (DUS)라 할 수 있습니다.  
When calculated for therapies, incidence proportions and incidence rates of use of a given therapy are classic population-level DUS.

## 고혈압 환자의 특성 분석 (Characterizing Hypertensive Persons)

World Health Organization (WHO)의 고혈압에 대한 보고서에 따르면 [@WHOHypertension], 고혈압의 초기 발견, 적절한 치료 그리고 관리에 상당한 건강과 경제적인 이득이 있습니다.
Per the World Health Organization’s (WHO) global brief on hypertension [@WHOHypertension], there are significant health and economic gains attached to early detection, adequate treatment and good control of hypertension. 
WHO의 보고서는 고혈압과 서로 다른 국가 간 질병 부담의 특성에 대한 전반적인 정보를 제공합니다. 
The WHO brief provides an overview of hypertension and characterizes the burden of the disease across different countries. 
고혈압에 대한 지역, 사회 경제적인 계급 그리고 성별에 대한 서술 통계를 제공합니다.  
The WHO provides descriptive statistics around hypertension for geographic regions, socio-economic class and gender. 

관찰형 데이터 소스는 WHO에서 한 것과 같은 고혈압 집단에 대한 특성 분석을 제공합니다. 
Observational data sources provide a way to characterize hypertensive populations as was done by the WHO. 
이 챕터의 다음 섹션에서는 ATLAS와 R을 이용해 고혈압 집단을 연구하기 위한 데이터베이스의 구성을 이해하기 위 데이터베이스를 탐색하는 방법을 살펴봅니다.  
In the subsequent sections of this chapter, we’ll explore the ways that we make use of ATLAS and R to explore a database to understand its composition for studying hypertensive populations. 
또한, 동일한 툴을 사용해 고혈압 집단의 자연사 (natural history)와 치료 패턴을 알아 볼 것입니다. 
Then, we will use these same tools to describe the natural history and treatment patterns of hypertensive populations.

## ATLAS에서 데이터베이스의 특성 분석 (Database Characterization in ATLAS)

여기서는 ATLAS의 데이터 소스 모듈을 사용하여 고혈압 환자와 관련된 데이터베이스 수준의 특성을 알아내기 위해 [ACHILLES](https://github.com/OHDSI/Achilles) 로 생성된 데이터베이스의 특성 분석 통계를 탐색하는 방법을 보여줍니다. 
Here we demonstrate how to use the data sources module in ATLAS to explore database characterization statistics created with [ACHILLES](https://github.com/OHDSI/Achilles) to find database level characteristics related to hypertensive persons. 
시작하려면 ATLAS의 왼쪽 바의 ![](images/Characterization/atlasDataSourcesMenuItem.png)을 클릭해 시작하십시오.
Start by clicking on ![](images/Characterization/atlasDataSourcesMenuItem.png) in the left bar of ATLAS to start. 

In the first drop down list shown in ATLAS, select the database to explore. Next, use the drop down below the database to start exploring reports. To do this, select the Condition Occurrence from the report drop down which will reveal a treemap visualization of all conditions present in the database:

```{r atlasDataSourcesConditionTreemap, fig.cap='Atlas Data Sources: Condition Occurrence Treemap',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasDataSourcesConditionTreemap.png")
```

To search for a specific condition of interest, click on the Table tab to reveal the full list of conditions in the database with person count, prevalence and records per person. Using the filter box on the top, we can filter down the entries in the table based on concept name containing the term "hypertension":

```{r atlasDataSourcesConditionFiltered, fig.cap='Atlas Data Sources: Conditions with "hypertension" found in the concept name',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasDataSourcesConditionFiltered.png")
```

We can explore a detailed drill-down report of a condition by clicking on a row. In this case, we will select "essential hypertension" to get a breakdown of the trends of the selected condition over time and by gender, the prevalence of the condition by month, the type recorded with the condition and the age at first occurrence of the diagnosis:

```{r atlasDataSourcesDrillDownReport, fig.cap='Atlas Data Sources: Essential hypertension drill down report',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasDataSourcesDrillDownReport.png")
```

Now that we have reviewed the database’s characteristics for the presence of hypertension concepts and the trends over time, we can also explore drugs used to treat hypertensive persons. The process to do this follows the same steps except we use the Drug Era report to review characteristics of drugs summarized to their RxNorm Ingredient. Once we have explored the database characteristics to review items of interest, we are ready to move forward with constructing cohorts to identify the hypertensive persons to characterize.

## Cohort Characterization in ATLAS

Here we demonstrate how to use ATLAS to perform large-scale cohort characterization for several cohorts. Click on the ![](images/Characterization/atlasCharacterizationMenuItem.png) in the left bar of ATLAS and create a new characterization analysis. Give the analysis a name a save using the ![](images/PopulationLevelEstimation/save.png) button.

### Design

A characterization analysis requires at least one cohort and at least one feature to characterize. For this example, we will use two cohorts. The first cohort will define persons initiating a treatment for hypertension as their index date with at least one diagnosis of hypertension in the year prior. We will also require that persons in this cohort have at least one year of observation after initiating the hypertensive drug (Appendix \@ref(HTN1yrFO)). The second cohort is identical to the first cohort described with a requirement having at least three years of observation instead of one (Appendix \@ref(HTN3yrFO)).

#### Cohort Definitions {-}

```{r atlasCharacterizationCohortSelection, fig.cap='Characterization design tab - cohort definition selection',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationCohortSelection.png")
```

We assume the cohorts have already been created in ATLAS as described in Chapter \@ref(Cohorts). Click on ![](images/Characterization/atlasImportButton.png) and select the cohorts as shown in figure \@ref(fig:atlasCharacterizationCohortSelection). Next, we’ll define the features to use for characterizing these two cohorts.

#### Feature Selection {-}

ATLAS comes with nearly 100 preset feature analyses that are used to perform characterization across the clinical domains modeled in the OMOP CDM. Each of these preset feature analyses perform aggregation and summarization functions on clinical observations for the selected target cohorts. These calculations provide potentially thousands of features to describe the cohorts baseline and post-index characteristics. Under the hood, ATLAS is utilizing the OHDSI FeatureExtraction R package to perform the characterization for each cohort. We will cover the use of FeatureExtraction and R in more detail in the next section. \index{feature analyses}

Click on ![](images/Characterization/atlasImportButton.png) to select the feature to characterize. Below is a list of features we will use to characterize these cohorts:

```{r atlasCharacterizationFeatureSelection, fig.cap='Characterization design tab - feature selection.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationFeatureSelection.png")
```

The figure above shows the list of features selected along with a description of what each feature will characterize for each cohort. The features that start with the name "Demographics" will calculate the demographic information for each person at the cohort start date. For the features that start with a domain name (i.e. Visit, Procedure, Condition, Drug, etc), these will characterize all recorded observations in that domain. Each domain feature has four options of time window preceding the cohort star, namely:

* **Any time prior**: uses all available time prior to cohort start that fall into the person’s observation period
* **Long term**: 365 days prior up to and including the cohort start date. 
* **Medium term**: 180 days prior up to and including the cohort start date. 
* **Short term**: 30 days prior up to and including the cohort start date. 

#### Subgroup Analysis {-}

What if we were interested in creating different characteristics based on gender? We can use the "subgroup analyses" section to define new subgroups of interest to use in our characterization.

To create a subgroup, click on and add your criteria for subgroup membership. This step is similar to the criteria used to identify cohort enrollment. In this example, we’ll define a set of criteria to identify females amongst our cohorts:
  
```{r atlasCharacterizationSubgroup, fig.cap='Characterization design with female sub group analysis.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationSubgroup.png")
```

```{block2, type='rmdimportant'}
Subgroup analyses in ATLAS are not the same as strata. Strata are mutually exclusive while subgroups may include the same persons based on the criteria chosen.
```

### Executions
Once we have our characterization designed, we can execute this design against one or more databases in our environment.  Navigate to the Executions tab and click on the Generate button to start the analysis on a database:


```{r atlasCharacterizationExecutions, fig.cap='Characterization design execution - CDM source selection.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationExecutions.png")
```

Once the analysis is complete, we can view reports by clicking on the "All Executions" button and from the list of executions, select "View Reports". Alternatively, you can click "View latest result" to view the last execution performed.

### Results


```{r atlasCharacterizationResultsSummary, fig.cap='Characterization results - condition occurrence long term.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationResultsSummary.png")
```

The results provide a tabular view of the different features for each cohort selected in the design. In figure \@ref(fig:atlasCharacterizationResultsSummary), a table provides a summary of all conditions present in the two cohorts in the preceding 365 days from the cohort start. Each covariate has a count and percentage for each cohort and the female subgroup we defined within each cohort. 

We used the search box to filter the results to see what proportion of persons have a `cardiac arrhythmia` in their history in an effort to understand what cardiovascular-related diagnoses are observed in the populations. We can use the `Explore` link next to the cardiac arrhythmia concept to open a new window with more details about the concept for a single cohort as shown in figure \@ref(fig:atlasCharacterizationResultsExplore):

```{r atlasCharacterizationResultsExplore, fig.cap='Characterization results - exploring a single concept.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationResultsExplore.png")
```

Since we have characterized all condition concepts for our cohorts, the explore option enables a view of all ancestor and descendant concepts for the selected concept, in this case cardiac arrhythmia. This exploration allows us to navigate the hierarchy of concepts to explore other cardiac diseases that may appear for our hypertensive persons. Like in the summary view, the count and percentage are displayed.

We can also use the same characterization results to find conditions that are contraindicated for some anti-hypertensive treatment such as angioedema. To do this, we’ll follow the same steps above but this time search for ‘edema’ as shown in figure \@ref(fig:atlasCharacterizationResultsContra):

```{r atlasCharacterizationResultsContra, fig.cap='Characterization results - exploring a contraindicated condition.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationResultsContra.png")
```
Once again, we’ll use the explore feature to see the characteristics of Edema in the hypertension population to find the prevalence of angioedema:

```{r atlasCharacterizationResultsContraExplore, fig.cap='Characterization results - exploring a contraindicated condition details.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationResultsContraExplore.png")
```

Here we find that a portion of this population has a record of angioedema in the year prior to starting an anti-hypertensive medication. 

```{r atlasCharacterizationResultsContinuous, fig.cap='Characterization results of age for each cohort and sub group.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationResultsContinuous.png")
```

While domain covariates are computed using a binary indicator (i.e. was a record of the code present in the prior timeframe), some variables provide a continuous value such as the age of persons at cohort start. In the example above, we show the age for the 2 cohorts characterized expressed with the count of persons, mean age, median age and standard deviation. 

### Defining Custom Features

In addition to the preset features, ATLAS supports the ability to allow for user-defined custom features. To do this, click the **Characterization** left-hand menu item, then click the **Feature Analysis** tab and click the **New Feature Analysis** button. Provide a name for the custom feature and save it using the ![](images/PopulationLevelEstimation/save.png) button. \index{ATLAS!characterization features}

In this example, we will define a custom feature that will identify the count of persons in each cohort that have a drug era of ACE inhibitors in their history after cohort start:

```{r atlasCharacterizationCustomFeature, fig.cap='Custom feature definition in ATLAS.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationCustomFeature.png")
```

The criteria defined above assumes that it will be applied to a cohort start date. Once we have defined the criteria and saved it, we can apply it to the characterization design we created in the previous section. To do this, open the characterization design and navigate to the Feature Analysis section. Click the ![](images/Characterization/atlasImportButton.png) button and from the menu select the new custom features. They will now appear in the feature list for the characterization design. As described earlier, we can execute this design against a database to produce the characterization for this custom feature:

```{r atlasCharacterizationCustomFeatureResults, fig.cap='Custom feature results display.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasCharacterizationCustomFeatureResults.png")
```

## Cohort Characterization in R

We may also choose to characterize cohorts using R. Here we’ll describe how to use the OHDSI R package FeatureExtraction to generate baseline features (covariates) for our hypertension cohorts. FeatureExtraction provides users with the ability to construct covariates in three ways: \index{FeatureExtraction}

* Choose the default set of covariates
* Choose from a set of pre-specified analyses
* Create a set of custom analyses

FeatureExtraction creates covariates in two distinct ways: person-level features and aggregate features. Person-level features are useful for machine learning applications. In this section, we’ll focus on using aggregate features that are useful for generating baseline covariates that describe the cohort of interest. Additionally, we’ll focus on the second two ways of constructing covariates: pre-specified and custom analyses and leave using the default set as an exercise for the reader.

### Cohort Instantiation

We first need to instantiate the cohort to characterize it. Instantiating cohorts is described in Chapter \@ref(Cohorts). In this example, we’ll use the persons initiating a first-line therapy for hypertension with 1 year follow up (Appendix \@ref(HTN1yrFO)). We leave characterizing the other cohorts in Appendix \@ref(CohortDefinitions) as an exercise for the reader. We will assume the cohort has been instantiated in a table called `scratch.my_cohorts` with cohort definition ID equal to 1.

### Data Extraction

We first need to tell R how to connect to the server. FeatureExtraction uses the DatabaseConnector package, which provides a function called `createConnectionDetails`. Type `?createConnectionDetails` for the specific settings required for the various database management systems (DBMS). For example, one might connect to a PostgreSQL database using this code:

```{r tidy=FALSE,eval=FALSE}
library(FeatureExtraction)
connDetails <- createConnectionDetails(dbms = "postgresql",
                                       server = "localhost/ohdsi",
                                       user = "joe",
                                       password = "supersecret")

cdmDbSchema <- "my_cdm_data"
cohortsDbSchema <- "scratch"
cohortsDbTable <- "my_cohorts"
cdmVersion <- "5"
```

The last four lines define the `cdmDbSchema`, `cohortsDbSchema`, and `cohortsDbTable` variables, as well as the CDM version. We will use these later to tell R where the data in CDM format live, where the cohorts of interest have been created, and what version CDM is used. Note that for Microsoft SQL Server, database schemas need to specify both the database and the schema, so for example `cdmDbSchema <- "my_cdm_data.dbo"`.

### Using Prespecified Analyses

The function `createCovariateSettings` allow the user to choose from a large set of predefined covariates. Type `?createCovariateSettings` to get an overview of the available options. For example: 

```{r tidy=FALSE,eval=FALSE}
settings <- createCovariateSettings(
  useDemographicsGender = TRUE, 
  useDemographicsAgeGroup = TRUE, 
  useConditionOccurrenceAnyTimePrior = TRUE) 
```

This will create binary covariates for gender, age (in 5 year age groups), and each concept observed in the condition_occurrence table any time prior to (and including) the cohort start date. 

Many of the prespecified analyses refer to a short, medium, or long term time window. By default, these windows are defined as: 

* **Long term**: 365 days prior up to and including the cohort start date. 
* **Medium term**: 180 days prior up to and including the cohort start date. 
* **Short term**: 30 days prior up to and including the cohort start date. 

However, the user can change these values. For example: 

```{r tidy=FALSE,eval=FALSE}
settings <- createCovariateSettings(useConditionEraLongTerm = TRUE, 
                                    useConditionEraShortTerm = TRUE, 
                                    useDrugEraLongTerm = TRUE,
                                    useDrugEraShortTerm = TRUE, 
                                    longTermStartDays = -180, 
                                    shortTermStartDays = -14, 
                                    endDays = -1) 
```

This redefines the long-term window as 180 days prior up to (but not including) the cohort start date, and redefines the short term window as 14 days prior up to (but not including) the cohort start date. 

Again, we can also specify which concept IDs should or should not be used to construct covariates: 

```{r tidy=FALSE,eval=FALSE}
settings <- createCovariateSettings(useConditionEraLongTerm = TRUE, 
                                    useConditionEraShortTerm = TRUE, 
                                    useDrugEraLongTerm = TRUE, 
                                    useDrugEraShortTerm = TRUE, 
                                    longTermStartDays = -180, 
                                    shortTermStartDays = -14, 
                                    endDays = -1, 
                                    excludedCovariateConceptIds = 1124300, 
                                    addDescendantsToExclude = TRUE, 
                                    aggregated = TRUE) 
```

```{block2, type='rmdimportant'}
The use of `aggregated = TRUE` for all of the examples above indicate to FeatureExtraction to provide summary statistics. Excluding this flag will compute covariates for each person in the cohort.
```


### Creating Aggregated Covariates

The following code block will generate aggregated statistics for a cohort: 

```{r tidy=FALSE,eval=FALSE}
covariateSettings <- createDefaultCovariateSettings() 

covariateData2 <- getDbCovariateData(
  connectionDetails = connectionDetails, 
  cdmDatabaseSchema = cdmDatabaseSchema, 
  cohortDatabaseSchema = resultsDatabaseSchema, 
  cohortTable = "cohorts_of_interest", 
  cohortId = 1, 
  covariateSettings = covariateSettings, 
  aggregated = TRUE) 

summary(covariateData2) 
```

And the output will look similar to the following:

```
## CovariateData Object Summary 
## 
## Number of Covariates: 41330 
## Number of Non-Zero Covariate Values: 41330
```

### Output Format

The two main components of the aggregated `covariateData` object are `covariates` and `covariatesContinuous` for binary and continuous covariates respectively:

```{r tidy=FALSE,eval=FALSE}
covariateData2$covariates
covariateData2$covariatesContinuous
```

### Custom Covariates

FeatureExtraction also provides the ability to define and utilize custom covariates. These details are an advanced topic and covered in the user documentation: http://ohdsi.github.io/FeatureExtraction/. 

## Cohort Pathways in ATLAS

The goal with a pathway analysis is to understand the sequencing of treatments along in one or more cohorts of interest. The methods applied are based on the design reported by @Hripcsak7329. These methods were generalized and codified into a feature called Cohort Pathways in ATLAS.

Cohort pathways aims to provide analytic capabilities to summarize the events following the cohort start date of one or more target cohorts. To do this, we create a set of cohorts to identify the clinical events of interest for the target population called event cohort. Focusing on how this might look for a person in the target cohort:

```{r pathwaysPersonEventView, fig.cap='Pathways analysis in the context of a single person.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/pathwaysPersonEventView.png")
```

In figure \@ref(fig:pathwaysPersonEventView), the person is part of the target cohort with a defined start and end date. Then, the numbered line segments represent where that person also is identified in an event cohort for a duration of time. Event cohorts allow us to describe any clinical event of interest that is represented in the CDM such that we are not constrained to creating a pathway for a single domain or concept. 

To start, click on ![](images/Characterization/atlasPathwaysMenuItem.png) in the left bar of ATLAS to create a new cohort pathways study. Provide a descriptive name and press the save button. 

### Design

To start, we will continue to use the cohorts initiating a first-line therapy for hypertension with 1 and 3 years follow up (Appendix \@ref(HTN1yrFO), \@ref(HTN3yrFO)). Use the  button to import the 2 cohorts.


```{r atlasPathwaysTargetCohorts, fig.cap='Pathways analysis with target cohorts selected.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasPathwaysTargetCohorts.png")
```

Next we’ll define the event cohorts by creating a cohort for each first-line hypertensive drug of interest. For this, we’ll start by creating a cohort of ACE inhibitor users and define the cohort end date as the end of continuous exposure. We’ll do the same for 8 other hypertensive medications and note that these definitions are found in Appendix \@ref(ACEiUse)-\@ref(A1BUse). Once complete use the ![](images/Characterization/atlasImportButton.png) button to import these into the Event Cohort section of the pathway design:


```{r atlasPathwaysEventCohorts, fig.cap='Event cohorts for pathway design for initiating a first-line antihypertensive therapy.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasPathwaysEventCohorts.png")
```

When complete, your design should look like the one above. Next, we’ll need to decide on a few additional analysis settings:

* **Combination window**: This setting allows you to define a window of time, in days, in which overlap between events is considered a combination of events. For example, if two drugs represented by 2 event cohorts (event cohort 1 and event cohort 2) overlap within the combination window the pathways algorithm will combine them into "event cohort 1 + event cohort 2".
* **Minimum cell count**: Event cohorts with less than this number of people will be censored (removed) from the output to protect privacy.
* **Max path length**: This refers to the maximum number of sequential events to consider for the analysis. 
  
### Executions

Once we have our pathway analysis designed, we can execute this design against one or more databases in our environment. This works the same way as we described for cohort characterization in ATLAS. Once complete, we can review the results of the analysis.

### Viewing Results

```{r atlasPathwaysResults, fig.cap='Pathways results legend and sunburst visualization.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasPathwaysResults.png")
```

The results of a pathway analysis are broken into 3 sections: The legend section displays the total number of persons in the target cohort along with the number of persons that had 1 or more events in the pathway analysis. Below that summary are the color designations for each of the cohorts that appear in the sunburst plot in the center section.

The sunburst plot is a visualization that represents the various event pathways taken by persons over time. The center of the plot represents the cohort entry and the first color-coded ring shows the proportion of persons in each event cohort. In our example, the center of the circle represents hypertensive persons initiating a first line therapy. Then, the first ring in the sunburst plot shows the proportion of persons that initiated a type of first-line therapy defined by the event cohorts (i.e. ACE inhibitors, Angiotensin receptor blockers, etc). The second set of rings represents the 2nd event cohort for persons. In certain event sequences, a person may never have a 2nd event cohort observed in the data and that proportion is represented by the grey portion of the ring. 


```{r atlasPathwaysResultsPathDetails, fig.cap='Pathways results displaying path details.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasPathwaysResultsPathDetails.png")
```

Clicking on a section of the sunburst plot will display the path details on the right. Here we can see that the largest proportion of people in our target cohort initiated a first-line therapy with ACE inhibitors and from that group, a smaller proportion started a Thiazide or thiazide diuretics. 

## Incidence Analysis in ATLAS

In an incidence calculation, we describe: amongst the persons in the target cohort, who experienced the outcome cohort during the time at risk period. Here we will design an incidence analysis to characterize angioedema and acute myocardial infarction outcomes amongst new users of ACE inhibitors (ACEi) and Thiazides and thiazide-like diuretics (THZ). We will assess these outcomes during the TAR that a person was exposed to the drug. Additionally, we will add an outcome of drug exposure to Angiotensin receptor blockers (ARBs) to measure the incidence of new use of ARBs during exposure to the target cohorts (ACEi and THZ). This outcome definition provides an understanding of how ARBs are utilized amongst the target populations.


To start, click on ![](images/Characterization/atlasIncidenceMenuItem.png) in the left bar of ATLAS to create a new incidence analysis. Provide a descriptive name and press the save button ![](images/PopulationLevelEstimation/save.png). 

### Design

We assume the cohorts used in this example have already been created in ATLAS as described in Chapter \@ref(Cohorts). The Appendix provides the full definitions of the target cohorts (Appendix \@ref(AceInhibitorsMono), \@ref(ThiazidesMono)), and outcomes (Appendix \@ref(Angioedema), \@ref(Ami), \@ref(ARBUse)) cohorts.


```{r atlasIncidenceCohortSelection, fig.cap='Incidence Rate target and outcome definition.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceCohortSelection.png")
```

On the definition tab, click to choose the *New users of ACE inhibitors* cohort and the *New users of Thiazide or Thiazide-like diuretics* cohort. Close the dialog to view that these cohorts are added to the design. Next we add our outcome cohorts by clicking on and from the dialog box, select the outcome cohorts of *acute myocardial infarction events*, *angioedema events* and *Angiotensin receptor blocker (ARB) use*. Again, close the window to view that these cohorts are added to the outcome cohorts section of the design. 

```{r atlasIncidenceTimeAtRisk, fig.cap='Incidence Rate target and outcome definition.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceTimeAtRisk.png")
```

Next, we will define the time at risk window for the analysis. As shown above, the time at risk window is defined relative to the cohort start and end dates. Here we will define the time at risk start as 1 day after cohort start for our target cohorts. Next, we’ll define the time at risk to end at the cohort end date. In this case, the definition of the ACEi and THZ cohorts have a cohort end date when the drug exposure ends.

ATLAS also provides a way to stratify the target cohorts as part of the analysis specification:


```{r atlasIncidenceStratifyFemale, fig.cap='Incidence Rate strata definition for females.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceStratifyFemale.png")
```

To do this, click the New Stratify Criteria button and follow the same steps described in Chapter 11. Now that we have completed the design, we can move to executing our design against one or more databases.

### Executions

Click the Generation tab and then the ![](images/Characterization/atlasIncidenceGenerate.png) button to reveal a list of databases to use to execute the analysis:

```{r atlasIncidenceSourceSelection, fig.cap='Incidence Rate analysis execution.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceSourceSelection.png")
```

Select one or more databases and click the Generate button to start the analysis to analyze all combinations of targets and outcomes specified in the design.

### Viewing Results

On the Generation tab, the top portion of the screen allows you to select a target and outcome to use when viewing the results. Just below this a summary of the incidence is shown for each database used in the analysis. 

Select the target cohort of ACEi users and the Acute Myocardial Infarction (AMI) from the respective dropdown lists. Click the ![](images/Characterization/atlasIncidenceReportButton.png) button to reveal the incidence analysis results:


```{r atlasIncidenceResults, fig.cap='Incidence Rate analysis output - New ACEi users with AMI outcome.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceResults.png")
```

A summary for the database shows the total persons in the cohort that were observed during the TAR along with the total number of cases. The proportion shows the number of cases per 1000 people. The time at risk, in years, is calculated for the target cohort. The incidence rate is expressed as the number of cases per 1000 person-years. 

We can also view the incidence metrics for the strata that we defined in the design. The same metrics mentioned above are calculated for each stratum. Additionally, a treemap visualization provides a representation of the proportion of each stratum represented by the boxed areas. The color represents the incidence rate as shown in the scale along the bottom.

We can gather the same information to see the incidence of new use of ARBs amongst the ACEi population. Using the dropdown at the top, change the outcome to ARBs use and click the ![](images/Characterization/atlasIncidenceReportButton.png) button to reveal the details. 

```{r atlasIncidenceResultsARB, fig.cap='Incidence Rate - New users of ACEi receiving ARBs treatment during ACEi exposure.',echo=FALSE, out.width='100%', fig.align='center'}
knitr::include_graphics("images/Characterization/atlasIncidenceResultsARB.png")
```

As shown, the metrics calculated are the same but the interpretation is different since the input (ARB use) references a drug utilization estimate instead of a health outcome.

## Summary

```{block2, type='rmdsummary'}
- OHDSI offers tools to characterize an entire database, or a cohort of interest.

- Cohort characterization describes a cohort of interest during the time preceding the index date (**baseline**) and the time after index (**post-index**).

- ATLAS's characterization module and the OHDSI Methods Library provide the capability to calculate baseline characteristics for multiple time windows.

- ATLAS's pathways and incidence rate modules provide descriptive statistics during the post-index time period.

```


## Exercises

#### Prerequisites {-}

For these exercises, access to an ATLAS instance is required. You can use the instance at [http://atlas-demo.ohdsi.org](http://atlas-demo.ohdsi.org), or any other instance you have acces to. 

```{exercise, exerciseCharacterization1}
We would like to understand how celecoxib is used in the real world. To start, we would like to understand what data a database has on this drug. Use the ATLAS Data Sources module to find information on celecoxib.

```

```{exercise, exerciseCharacterization2}
We would like to better understand the disease natural history of celecoxib users. Create a simple cohort of new users of celecoxib using a 365-day washout period (see Chapter \@ref(Cohorts) for details on how to do this), and use ATLAS to create a characterization of this cohort, showing co-morbid conditions and drug-exposures.

```

```{exercise, exerciseCharacterization3}
We are interested in understand how often gastrointestinal (GI) bleeds occur any time after people initiate celecoxib treatment. Create a cohort of GI bleed events, simply defined as any occurrence of concept [192671](http://athena.ohdsi.org/search-terms/terms/192671) ("Gastrointestinal hemorrhage") or any of its descendants. Compute the incidence rate of these GI events after celecoxib initiation, using the exposure cohort defined in the previous exercise.

```

Suggested answers can be found in Appendix \@ref(Characterizationanswers).

